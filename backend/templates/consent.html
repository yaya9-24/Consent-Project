<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì „ì ë™ì˜ì„œ - ë™ì˜ì„œ ì¶”ê°€/ì œê±° ê¸°ëŠ¥ í¬í•¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 40px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #f9f9f9;
      position: relative;
    }
    .pdf-container {
      margin-top: 20px;
      padding: 0;
      position: relative;
    }
    .canvas-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    canvas {
      border: 1px solid black;
    }
    .toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #333;
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
      z-index: 1000;
    }
    .toolbar button {
      padding: 8px;
      border: none;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      border-radius: 5px;
    }
    #settings-panel {
      margin-top: 60px;
      text-align: center;
    }
    #settings-panel > div {
      display: none;
      margin-bottom: 10px;
    }
    #consent-sidebar {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: row;
      gap: 10px;
      background-color: rgba(255,255,255,0.95);
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      z-index: 2000;
    }
    .layer {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #layer2, #layer3 {
      display: none;
    }
    #consent-sidebar button {
      padding: 8px;
      border: none;
      cursor: pointer;
      background-color: #28a745;
      color: white;
      border-radius: 5px;
    }
    .consent-table {
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
    }

    @media (max-width: 768px) {
        .consent-table th,
        .consent-table td {
            font-size: 14px;
            padding: 5px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button onclick="setTool('cursor')">ì»¤ì„œ</button>
    <button onclick="setTool('pen')">íœ</button>
    <button onclick="setTool('highlight')">í˜•ê´‘íœ</button>
    <button onclick="setTool('text')">í…ìŠ¤íŠ¸ ì…ë ¥</button>
    <button onclick="setTool('eraser')">ì „ì²´ ì§€ì›€</button>
  </div>
  
  <div id="settings-panel">
    <div id="pen-settings">
      <label>íœ ë‘ê»˜: 
        <input type="range" id="pen-thickness" min="1" max="20" value="5">
      </label>
    </div>
    <div id="highlight-settings">
      <label>í˜•ê´‘íœ ë‘ê»˜: 
        <input type="range" id="highlight-thickness" min="1" max="20" value="16">
      </label>
      <label>í˜•ê´‘íœ íˆ¬ëª…ë„: 
        <input type="range" id="highlight-opacity" min="0" max="1" step="0.1" value="0.2">
      </label>
    </div>
  </div>

  <div id="signature-modal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid #000; z-index: 2000;">
    <h3>ì„œëª… ì…ë ¥</h3>
    <canvas id="signature-canvas" width="300" height="150" style="border: 1px solid black;"></canvas>
    <br>
    <button onclick="clearSignature()">ì§€ìš°ê¸°</button>
    <button onclick="saveSignature()">ì €ì¥</button>
    <button onclick="closeModal()">ì·¨ì†Œ</button>
  </div>

  <div class="container">
    <h1>ì „ì ë™ì˜ì„œ</h1>
    <p>ì•„ë˜ì—ì„œ ê¸°ë³¸ ë™ì˜ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
    <div id="pdf-container" class="pdf-container"></div>
    <br>
    <a href="/">ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <div id="consent-sidebar">
    <div id="layer1" class="layer">
      <button onclick="selectLayer1('surgery')">ìˆ˜ìˆ </button>
      <button onclick="selectLayer1('procedure')">ì‹œìˆ </button>
      <button onclick="selectLayer1('underlying')">ê¸°ì €ì§ˆí™˜</button>
    </div>
    <div id="layer2" class="layer"></div>
    <div id="layer3" class="layer"></div>
  </div>

  <button onclick="openSignatureModal()">ì„œëª…í•˜ê¸°</button>
  <button onclick="finalizeSignatures()">ì‘ì„± ì™„ë£Œ</button>

  <script>
    console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨");

    /* ----- PencilBrushì˜ createPath ì˜¤ë²„ë¼ì´ë“œ (opacity ì ìš©) ----- */
    if (fabric.PencilBrush) {
      fabric.PencilBrush.prototype.createPath = function(pathData) {
        return new fabric.Path(pathData, {
          fill: null,
          stroke: this.color,
          strokeWidth: this.width,
          opacity: this.opacity,
          strokeLineCap: this.strokeLineCap || 'round',
          strokeLineJoin: this.strokeLineJoin || 'round'
        });
      };
    }

    // PDF.js ì„¤ì •
    var pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    let activeTool = "cursor";
    let selectedConsents = ["basic_consent"];
    let pdfContainer = document.getElementById("pdf-container");
    let fabricCanvases = [];
    let consentPages = {};
    let selectedSignatureAreaList = [];

    function loadSignatureAreas(consent) {
      const encodedConsent = encodeURIComponent(consent);
      const url = `/backend/get_signature_areas/${encodedConsent}_signature_areas.json`;
      //console.log("ğŸ”„ ì„œëª… ì˜ì—­ ë¡œë“œ URL:", url);
      fetch(url)
        .then(response => response.json())
        .then(data => {
          //console.log("âœ… ë¶ˆëŸ¬ì˜¨ ì„œëª… ì˜ì—­ ë°ì´í„°:", data);
          let consentPagesArray = [...pdfContainer.children]
            .filter(page => page.dataset.consentId === consent)
            .sort((a, b) => parseInt(a.dataset.pageNumber) - parseInt(b.dataset.pageNumber));
          //console.log(`âœ… ë™ì˜ì„œ ${consent}ì˜ í˜ì´ì§€ ë°°ì—´:`, consentPagesArray);
          data.forEach(area => {
            let pageIndex = area.page - 1;
            let pageWrapper = consentPagesArray[pageIndex];
            if (!pageWrapper) {
              console.warn(`ğŸš¨ ë™ì˜ì„œ ${consent}ì— í˜ì´ì§€ ${area.page}ê°€ ì—†ìŠµë‹ˆë‹¤.`);
              return;
            }
            let canvas = pageWrapper.fabricCanvas;
            if (!canvas) {
              console.warn(`ğŸš¨ í•´ë‹¹ í˜ì´ì§€(${area.page})ì˜ Fabric ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
              return;
            }
            let rect = new fabric.Rect({
              left: area.left,
              top: area.top,
              width: area.width,
              height: area.height,
              fill: 'rgba(255, 255, 0, 0.1)',
              selectable: false,
              dataType: 'signatureArea' // ì„œëª… ì˜ì—­ ì‹ë³„ìš© ì†ì„± ì¶”ê°€
            });
            rect.parentConsentId = consent;
            rect.page = area.page;
            canvas.add(rect);
            selectedSignatureAreaList.push({
              consentId: consent,
              left: area.left,
              top: area.top,
              width: area.width,
              height: area.height,
              page: area.page,
              canvasHeight: parseFloat(pageWrapper.dataset.canvasHeight)
            });
          });
          consentPagesArray.forEach(page => {
            if (page.fabricCanvas) page.fabricCanvas.requestRenderAll();
          });
        })
        .catch(error => console.error("ğŸš¨ ì„œëª… ì˜ì—­ ë¡œë“œ ì‹¤íŒ¨:", error));
    }

    let consentOrderCounter = 0;
    function loadPdf(consent) {
      consentOrderCounter++;
      let currentConsentOrder = consentOrderCounter;
      let loadingTask = pdfjsLib.getDocument(`/static/pdfs/${consent}.pdf`);
      loadingTask.promise.then(pdf => {
        //console.log(`ğŸ“„ PDF ë¬¸ì„œ ë¡œë“œë¨: ${consent}, ì´ í˜ì´ì§€ ìˆ˜: ${pdf.numPages}`);
        let pagePromises = [];
        let newConsentPages = [];
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pagePromises.push(
            pdf.getPage(pageNum).then(page => {
              let viewport = page.getViewport({ scale: 1.34 });
              let canvasWrapper = document.createElement("div");
              canvasWrapper.className = "canvas-wrapper";
              canvasWrapper.dataset.pageNumber = pageNum;
              canvasWrapper.dataset.consentId = consent;
              canvasWrapper.dataset.pageCount = pdf.numPages;
              canvasWrapper.dataset.consentOrder = currentConsentOrder;
              canvasWrapper.style.width = viewport.width + "px";
              canvasWrapper.style.height = viewport.height + "px";
              let pdfCanvas = document.createElement("canvas");
              pdfCanvas.width = viewport.width;
              pdfCanvas.height = viewport.height;
              pdfCanvas.style.position = "absolute";
              pdfCanvas.style.top = "0";
              pdfCanvas.style.left = "0";
              pdfCanvas.style.pointerEvents = "none";
              canvasWrapper.dataset.canvasHeight = viewport.height;
              //console.log(`PDF Canvas Height for page ${pageNum}: ${viewport.height}`);
              let overlayCanvas = document.createElement("canvas");
              overlayCanvas.width = viewport.width;
              overlayCanvas.height = viewport.height;
              overlayCanvas.style.position = "absolute";
              overlayCanvas.style.top = "0";
              overlayCanvas.style.left = "0";
              overlayCanvas.style.pointerEvents = "auto";
              overlayCanvas.style.zIndex = "100";
              overlayCanvas.style.touchAction = "none";
              let context = pdfCanvas.getContext("2d");
              page.render({ canvasContext: context, viewport: viewport });
              canvasWrapper.appendChild(pdfCanvas);
              canvasWrapper.appendChild(overlayCanvas);
              newConsentPages.push(canvasWrapper);
              let fabricCanvas = new fabric.Canvas(overlayCanvas, { selection: true });
              fabricCanvas.isDrawingMode = false;
              fabricCanvas.defaultCursor = "default";
              fabricCanvas.hoverCursor = "move";
              fabricCanvas.perPixelTargetFind = true;
              fabricCanvas.targetFindTolerance = 5;
              fabricCanvas.calcOffset();
              canvasWrapper.fabricCanvas = fabricCanvas;              
              return { pageNum: pageNum, wrapper: canvasWrapper };
            })
          );
        }
        Promise.all(pagePromises).then(() => {
          let allPages = [...pdfContainer.children, ...newConsentPages];
          allPages.sort((a, b) => {
            let orderA = parseInt(a.dataset.consentOrder, 10) || 0;
            let orderB = parseInt(b.dataset.consentOrder, 10) || 0;
            if (orderA !== orderB) return orderA - orderB;
            return parseInt(a.dataset.pageNumber, 10) - parseInt(b.dataset.pageNumber, 10);
          });
          pdfContainer.innerHTML = "";
          allPages.forEach(page => pdfContainer.appendChild(page));
          consentPages[consent] = newConsentPages;
          newConsentPages.forEach(page => {
            if (page.fabricCanvas) fabricCanvases.push(page.fabricCanvas);
          });
          //console.log(`âœ… ë™ì˜ì„œ ${consent} í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ:`, newConsentPages);
          loadSignatureAreas(consent);
        });
      }).catch(error => console.error("ğŸš¨ PDF ë¡œë“œ ì—ëŸ¬:", error));
    }

    function setTool(tool) {
      activeTool = tool;
      console.log("ì„ íƒëœ ë„êµ¬:", tool);
      if (tool === "pen") {
        document.getElementById("pen-settings").style.display = "inline-block";
        document.getElementById("highlight-settings").style.display = "none";
      } else if (tool === "highlight") {
        document.getElementById("pen-settings").style.display = "none";
        document.getElementById("highlight-settings").style.display = "inline-block";
      } else {
        document.getElementById("pen-settings").style.display = "none";
        document.getElementById("highlight-settings").style.display = "none";
      }
      fabricCanvases.forEach(function(fabricCanvas) {
        if (tool === "pen") {
          fabricCanvas.isDrawingMode = false;
          fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(fabricCanvas);
          let penThickness = document.getElementById("pen-thickness").value;
          fabricCanvas.freeDrawingBrush.color = "black";
          fabricCanvas.freeDrawingBrush.width = parseFloat(penThickness);
          fabricCanvas.freeDrawingBrush.opacity = 1;
          fabricCanvas.isDrawingMode = true;
        } else if (tool === "highlight") {
          fabricCanvas.isDrawingMode = false;
          fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(fabricCanvas);
          let highlightThickness = document.getElementById("highlight-thickness").value;
          let highlightOpacity = document.getElementById("highlight-opacity").value;
          fabricCanvas.freeDrawingBrush.color = "yellow";
          fabricCanvas.freeDrawingBrush.width = parseFloat(highlightThickness);
          fabricCanvas.freeDrawingBrush.opacity = parseFloat(highlightOpacity);
          fabricCanvas.isDrawingMode = true;
        } else if (tool === "text") {
          fabricCanvas.isDrawingMode = false;
          //console.log("í…ìŠ¤íŠ¸ ì…ë ¥ í™œì„±í™”ë¨!");
          fabricCanvas.once('mouse:down', function(event) {
            if (activeTool === "text") {
              let pointer = fabricCanvas.getPointer(event.e);
              addText(fabricCanvas, pointer.x, pointer.y);
            }
          });
        } else if (tool === "eraser") {
          fabricCanvas.isDrawingMode = false;
          fabricCanvas.clear();
        } else {
          fabricCanvas.isDrawingMode = false;
        }
        fabricCanvas.calcOffset();
        fabricCanvas.renderAll();
      });
    }

    function addText(canvas, left, top) {
      let text = new fabric.IText("ì…ë ¥í•˜ì„¸ìš”", {
        left: left,
        top: top,
        fontSize: 20,
        fill: "black",
        fontFamily: "Arial",
        selectable: true,
        editable: true
      });
      canvas.add(text);
      canvas.setActiveObject(text);
      canvas.renderAll();
      console.log("í…ìŠ¤íŠ¸ ì¶”ê°€ë¨:", text);
      setTimeout(() => {
        text.enterEditing();
        text.selectAll();
      }, 100);
      activeTool = "cursor";
    }

    document.getElementById("pen-thickness").addEventListener("input", function() {
      let thickness = parseFloat(this.value);
      fabricCanvases.forEach(function(canvas) {
        if (activeTool === "pen") {
          canvas.isDrawingMode = false;
          canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.color = "black";
          canvas.freeDrawingBrush.width = thickness;
          canvas.freeDrawingBrush.opacity = 1;
          canvas.isDrawingMode = true;
          canvas.calcOffset();
          canvas.renderAll();
        }
      });
    });
    document.getElementById("highlight-thickness").addEventListener("input", function() {
      let thickness = parseFloat(this.value);
      fabricCanvases.forEach(function(canvas) {
        if (activeTool === "highlight") {
          canvas.isDrawingMode = false;
          canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.color = "yellow";
          canvas.freeDrawingBrush.width = thickness;
          canvas.freeDrawingBrush.opacity = parseFloat(document.getElementById("highlight-opacity").value);
          canvas.isDrawingMode = true;
          canvas.calcOffset();
          canvas.renderAll();
        }
      });
    });
    document.getElementById("highlight-opacity").addEventListener("input", function() {
      let opacityValue = parseFloat(this.value);
      fabricCanvases.forEach(function(canvas) {
        if (activeTool === "highlight") {
          canvas.isDrawingMode = false;
          canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.color = "yellow";
          canvas.freeDrawingBrush.width = parseFloat(document.getElementById("highlight-thickness").value);
          canvas.freeDrawingBrush.opacity = opacityValue;
          canvas.isDrawingMode = true;
          canvas.calcOffset();
          canvas.renderAll();
        }
      });
    });
    window.addEventListener("resize", function() {
      fabricCanvases.forEach(function(canvas) {
        canvas.calcOffset();
      });
    });

    function selectLayer1(category) {
      const layer1Div = document.getElementById('layer1');
      layer1Div.innerHTML = `<button onclick="resetLayer1()">< ë’¤ë¡œê°€ê¸°</button><span style="margin-left:5px; font-weight:bold;">${category}</span>`;
      let layer2Data = [];
      if (category === 'surgery') {
        layer2Data = ["ì‹¬ì¥ ìˆ˜ìˆ ", "ë‡Œ ìˆ˜ìˆ ", "ë³µë¶€ ìˆ˜ìˆ ", "ì •í˜•ì™¸ê³¼ ìˆ˜ìˆ ", "í‰ë¶€ ìˆ˜ìˆ ", "ì†Œì•„ì™¸ê³¼ ìˆ˜ìˆ ", "ì„±í˜• ìˆ˜ìˆ ", "ë¹„ë‡¨ê¸°ê³¼ ìˆ˜ìˆ ", "ì•ˆë©´ ìˆ˜ìˆ ", "ì¼ë°˜ì™¸ê³¼ ìˆ˜ìˆ "];
      } else if (category === 'procedure') {
        layer2Data = ["ì¹˜ê³¼ ì‹œìˆ ", "ì•ˆê³¼ ì‹œìˆ ", "í”¼ë¶€ ì‹œìˆ ", "ì •í˜• ì‹œìˆ ", "ë‚´ì‹œê²½ ì‹œìˆ ", "ë ˆì´ì € ì‹œìˆ ", "ì£¼ì‚¬ ì‹œìˆ ", "ì¬í™œ ì‹œìˆ ", "ë¯¸ìš© ì‹œìˆ ", "ë¹„ì¹¨ìŠµ ì‹œìˆ "];
      } else if (category === 'underlying') {
        layer2Data = ["ë‹¹ë‡¨ë³‘", "ê³ í˜ˆì••", "ì‹¬í˜ˆê´€ ì§ˆí™˜", "ë§Œì„± í˜¸í¡ê¸° ì§ˆí™˜", "ë§Œì„± ì‹ ì¥ ì§ˆí™˜", "ê°„ ì§ˆí™˜", "ë©´ì—­ ì§ˆí™˜", "ë¹„ë§Œ", "ê°‘ìƒì„  ì§ˆí™˜", "ê´€ì ˆì—¼"];
      }
      const layer2Div = document.getElementById('layer2');
      layer2Div.innerHTML = '';
      layer2Data.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item;
        btn.onclick = function() { selectLayer2(category, item); };
        layer2Div.appendChild(btn);
      });
      layer2Div.style.display = "flex";
      const layer3Div = document.getElementById('layer3');
      layer3Div.innerHTML = '';
      layer3Div.style.display = "none";
    }
    function resetLayer1() {
      const layer1Div = document.getElementById('layer1');
      layer1Div.innerHTML = `
        <button onclick="selectLayer1('surgery')">ìˆ˜ìˆ </button>
        <button onclick="selectLayer1('procedure')">ì‹œìˆ </button>
        <button onclick="selectLayer1('underlying')">ê¸°ì €ì§ˆí™˜</button>
      `;
      document.getElementById('layer2').innerHTML = '';
      document.getElementById('layer2').style.display = "none";
      document.getElementById('layer3').innerHTML = '';
      document.getElementById('layer3').style.display = "none";
    }
    function selectLayer2(category, subCategory) {
      const layer2Div = document.getElementById('layer2');
      layer2Div.innerHTML = `<button onclick="resetLayer2('${category}')">< ë’¤ë¡œê°€ê¸°</button><span style="margin-left:5px; font-weight:bold;">${subCategory}</span>`;
      let layer3Data = [];
      if (category === 'surgery') {
        if(subCategory === "ì‹¬ì¥ ìˆ˜ìˆ "){
          layer3Data = ["ë§ˆì·¨ ë™ì˜ì„œ", "ê´€ì ˆê²½ ê²€ì‚¬", "ì‹¬ê·¼ì¬ìƒì¹˜ë£Œ ë™ì˜ì„œ", "ì‹¬ì¥ë™ë§¥ìŠ¤í…íŠ¸ ì‚½ì… ë™ì˜ì„œ", "ì‹¬ì¥ì „ë„ê³„ ìˆ˜ìˆ  ë™ì˜ì„œ"];
        } else if(subCategory === "ë‡Œ ìˆ˜ìˆ "){
          layer3Data = ["ë‡Œì¢…ì–‘ ì ˆì œìˆ  ë™ì˜ì„œ", "ë‡Œë™ë§¥ë¥˜ í´ë¦¬í•‘ ë™ì˜ì„œ", "ë‡Œì¶œí˜ˆ ì‘ê¸‰ ìˆ˜ìˆ  ë™ì˜ì„œ", "ë‡Œì‹ ê²½ ì¬ê±´ìˆ  ë™ì˜ì„œ", "ë‡Œë‚´ ì¶œí˜ˆ ì¹˜ë£Œ ë™ì˜ì„œ"];
        }
      } else if (category === 'procedure') {
        if(subCategory === "ì¹˜ê³¼ ì‹œìˆ "){
          layer3Data = ["ì„í”Œë€íŠ¸ ì‹œìˆ  ë™ì˜ì„œ", "ì¹˜ì•„ êµì • ì‹œìˆ  ë™ì˜ì„œ", "ì¹˜ì£¼ ì¹˜ë£Œ ë™ì˜ì„œ", "ë³´ì²  ì¹˜ë£Œ ë™ì˜ì„œ", "ì¹˜ê·¼ ì ˆì œ ì‹œìˆ  ë™ì˜ì„œ"];
        }
      } else if (category === 'underlying') {
        if(subCategory === "ë‹¹ë‡¨ë³‘"){
          layer3Data = ["ë‹¹ë‡¨ë³‘ ê´€ë¦¬ ë™ì˜ì„œ", "ë‹¹ë‡¨ë³‘ ì¹˜ë£Œ ë™ì˜ì„œ", "ì¸ìŠë¦° íˆ¬ì—¬ ë™ì˜ì„œ", "í˜ˆë‹¹ ê´€ë¦¬ ë™ì˜ì„œ", "ë‹¹ë‡¨ í•©ë³‘ì¦ ì˜ˆë°© ë™ì˜ì„œ"];
        }
      }
      const layer3Div = document.getElementById('layer3');
      layer3Div.innerHTML = '';
      layer3Data.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item;
        btn.onclick = function() { selectFinalConsent(item, this); };
        if (selectedConsents.includes(item)) {
          btn.style.backgroundColor = "#aaa";
          btn.style.cursor = "default";
        }
        layer3Div.appendChild(btn);
      });
      layer3Div.style.display = "flex";
    }
    function resetLayer2(category) {
      let layer2Data = [];
      if (category === 'surgery') {
        layer2Data = ["ì‹¬ì¥ ìˆ˜ìˆ ", "ë‡Œ ìˆ˜ìˆ ", "ë³µë¶€ ìˆ˜ìˆ ", "ì •í˜•ì™¸ê³¼ ìˆ˜ìˆ ", "í‰ë¶€ ìˆ˜ìˆ ", "ì†Œì•„ì™¸ê³¼ ìˆ˜ìˆ ", "ì„±í˜• ìˆ˜ìˆ ", "ë¹„ë‡¨ê¸°ê³¼ ìˆ˜ìˆ ", "ì•ˆë©´ ìˆ˜ìˆ ", "ì¼ë°˜ì™¸ê³¼ ìˆ˜ìˆ "];
      } else if (category === 'procedure') {
        layer2Data = ["ì¹˜ê³¼ ì‹œìˆ ", "ì•ˆê³¼ ì‹œìˆ ", "í”¼ë¶€ ì‹œìˆ ", "ì •í˜• ì‹œìˆ ", "ë‚´ì‹œê²½ ì‹œìˆ ", "ë ˆì´ì € ì‹œìˆ ", "ì£¼ì‚¬ ì‹œìˆ ", "ì¬í™œ ì‹œìˆ ", "ë¯¸ìš© ì‹œìˆ ", "ë¹„ì¹¨ìŠµ ì‹œìˆ "];
      } else if (category === 'underlying') {
        layer2Data = ["ë‹¹ë‡¨ë³‘", "ê³ í˜ˆì••", "ì‹¬í˜ˆê´€ ì§ˆí™˜", "ë§Œì„± í˜¸í¡ê¸° ì§ˆí™˜", "ë§Œì„± ì‹ ì¥ ì§ˆí™˜", "ê°„ ì§ˆí™˜", "ë©´ì—­ ì§ˆí™˜", "ë¹„ë§Œ", "ê°‘ìƒì„  ì§ˆí™˜", "ê´€ì ˆì—¼"];
      }
      const layer2Div = document.getElementById('layer2');
      layer2Div.innerHTML = '';
      layer2Data.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item;
        btn.onclick = function() { selectLayer2(category, item); };
        layer2Div.appendChild(btn);
      });
      layer2Div.style.display = "flex";
      const layer3Div = document.getElementById('layer3');
      layer3Div.innerHTML = '';
      layer3Div.style.display = "none";
    }
    function selectFinalConsent(consentId, btn) {
      if (selectedConsents.includes(consentId)) {
        if (confirm(consentId + " ë™ì˜ì„œëŠ” ì´ë¯¸ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          removeConsent(consentId);
          btn.style.backgroundColor = "#28a745";
          btn.style.cursor = "pointer";
        }
        return;
      }
      selectedConsents.push(consentId);
      loadPdf(consentId);
      alert(consentId + " ë™ì˜ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      btn.style.backgroundColor = "#aaa";
      btn.style.cursor = "default";
    }
    function removeConsent(consent) {
      if (!selectedConsents.includes(consent)) {
        alert(consent + " ë™ì˜ì„œëŠ” ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      console.log(`ì‚­ì œ ìš”ì²­ëœ ë™ì˜ì„œ: ${consent}`);
      if (consentPages[consent]) {
        consentPages[consent].forEach(wrapper => {
          if (pdfContainer.contains(wrapper)) {
            pdfContainer.removeChild(wrapper);
            console.log(`âœ… ì‚­ì œëœ ë™ì˜ì„œ í˜ì´ì§€: ${consent}`);
          } else {
            console.warn(`ğŸš¨ ì‚­ì œí•˜ë ¤ëŠ” ë™ì˜ì„œ(${consent})ì˜ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ`);
          }
        });
        delete consentPages[consent];
      } else {
        console.warn(`ğŸš¨ consentPages[${consent}]ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ`);
      }
      let updatedCanvases = [];
      fabricCanvases.forEach(canvas => {
        if (!canvas.wrapper || canvas.wrapper.dataset.consentId !== consent) {
          updatedCanvases.push(canvas);
        } else {
          console.log(`âœ… ì‚­ì œëœ fabricCanvas ê´€ë ¨ ë™ì˜ì„œ: ${consent}`);
        }
      });
      fabricCanvases = updatedCanvases;
      selectedConsents = selectedConsents.filter(item => item !== consent);
      //console.log(`âœ… í˜„ì¬ ì„ íƒëœ ë™ì˜ì„œ ëª©ë¡:`, selectedConsents);
      alert(consent + " ë™ì˜ì„œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === "Delete") {
        fabricCanvases.forEach(function(canvas) {
          let activeObjects = canvas.getActiveObjects();
          if (activeObjects.length > 0) {
            activeObjects.forEach(function(obj) {
              canvas.remove(obj);
            });
            canvas.discardActiveObject();
            canvas.requestRenderAll();
          }
        });
      }
    });
    

    let signatureCanvas = new fabric.Canvas('signature-canvas');
    signatureCanvas.isDrawingMode = true;
    signatureCanvas.freeDrawingBrush.width = 3;
    signatureCanvas.freeDrawingBrush.color = "black";

    function openSignatureModal() {
      document.getElementById('signature-modal').style.display = 'block';
    }
    function closeModal() {
      document.getElementById('signature-modal').style.display = 'none';
      signatureCanvas.clear();
    }
    function clearSignature() {
      signatureCanvas.clear();
    }

    function applySignaturePreview(area, signatureDataUrl, consentId) {
      let consentPagesArray = [...pdfContainer.children]
        .filter(page => page.dataset.consentId === consentId)
        .sort((a, b) => parseInt(a.dataset.pageNumber) - parseInt(b.dataset.pageNumber));
      let pageIndex = area.page - 1;
      let pageWrapper = consentPagesArray[pageIndex];
      if (!pageWrapper) {
        console.error(`ğŸš¨ ë™ì˜ì„œ ${consentId}ì— í˜ì´ì§€ ${area.page}ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      let canvas = pageWrapper.fabricCanvas;
      if (!canvas) {
        console.error(`ğŸš¨ í˜ì´ì§€ ${area.page}ì— Fabric ìº”ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      fabric.Image.fromURL(signatureDataUrl, function(img) {
        img.scaleToWidth(area.width);
        img.scaleToHeight(area.height);
        img.set({
          left: area.left,
          top: area.top,
          selectable: false,
          dataType: 'signature'
        });
        canvas.add(img);
        canvas.renderAll();
      }, { crossOrigin: 'anonymous' });
      //console.log(`âœ… ì„œëª… ë¯¸ë¦¬ë³´ê¸° ì ìš© ì™„ë£Œ: ë™ì˜ì„œ ${consentId}, í˜ì´ì§€ ${area.page}`);
    }

    let savedSignatureData = null;

    function saveSignature() {
      let signatureData = signatureCanvas.toDataURL({ format: 'png', multiplier: 3 });
      //console.log("Signature Data URL:", signatureData);
      if (!signatureData) {
        alert("ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”!");
        return;
      }
      savedSignatureData = signatureData;
      selectedSignatureAreaList.forEach(area => {
        let consentId = area.consentId;
        let pageWrapper = document.querySelector(`[data-consent-id="${consentId}"][data-page-number="${area.page}"]`);
        if (!pageWrapper) {
          console.error(`ğŸš¨ í•´ë‹¹ ë™ì˜ì„œ(${consentId})ì˜ í˜ì´ì§€(${area.page})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          return;
        }
        let canvas = pageWrapper.fabricCanvas;
        if (!canvas) {
          console.error(`ğŸš¨ í˜ì´ì§€ ${area.page}ì˜ Fabric ìº”ë²„ìŠ¤ê°€ ì—†ìŒ`);
          return;
        }
        applySignaturePreview(area, signatureData, consentId);

        let scaleFactor = canvas.width / 800;
        area.scaleFactor = scaleFactor;
        area.pdfHeight = parseFloat(pageWrapper.dataset.canvasHeight);
        //console.log(`Signature Area with Scale:`, area);
      });
      alert("ëª¨ë“  ì„œëª… ì˜ì—­ì— ì„œëª…ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
      closeModal();
    }

    function finalizeSignatures() {
      let signatureData = savedSignatureData;
      //console.log("Signature Data URL in finalize:", signatureData);
      if (!signatureData) {
        alert("ì„œëª… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      let canvasImages = [];
      let allPages = [...pdfContainer.children].sort((a, b) => {
        let orderA = parseInt(a.dataset.consentOrder, 10) || 0;
        let orderB = parseInt(b.dataset.consentOrder, 10) || 0;
        if (orderA !== orderB) return orderA - orderB;
        return parseInt(a.dataset.pageNumber, 10) - parseInt(b.dataset.pageNumber, 10);
      });

      allPages.forEach(pageWrapper => {
        let canvas = pageWrapper.fabricCanvas;
        if (!canvas) {
          console.error(`ğŸš¨ í˜ì´ì§€ ${pageWrapper.dataset.pageNumber}ì˜ Fabric ìº”ë²„ìŠ¤ê°€ ì—†ìŒ`);
          return;
        }

        let objects = canvas.getObjects();
        //console.log(`[DEBUG] ìº”ë²„ìŠ¤ ê°ì²´ ëª©ë¡ (í˜ì´ì§€ ${pageWrapper.dataset.pageNumber}):`, objects);

        // ì„œëª… ì´ë¯¸ì§€ì™€ ì„œëª… ì˜ì—­ ì œì™¸
        let contentObjects = objects.filter(obj => {
          let isSignature = obj instanceof fabric.Image && !obj.selectable && obj.dataType === 'signature';
          let isSignatureArea = obj instanceof fabric.Rect && obj.dataType === 'signatureArea';
          return !isSignature && !isSignatureArea;
        });
        //console.log(`[DEBUG] ì„œëª… ì´ë¯¸ì§€ì™€ ì„œëª… ì˜ì—­ì„ ì œì™¸í•œ ê°ì²´ (í˜ì´ì§€ ${pageWrapper.dataset.pageNumber}):`, contentObjects);

        let tempCanvas = new fabric.Canvas(null);
        tempCanvas.setDimensions({ width: canvas.width, height: canvas.height });

        let promises = contentObjects.map(obj => {
          return new Promise((resolve, reject) => {
            try {
              obj.clone(cloned => {
                if (cloned) {
                  tempCanvas.add(cloned);
                  resolve();
                } else {
                  //console.warn(`[DEBUG] ê°ì²´ ë³µì‚¬ ì‹¤íŒ¨:`, obj);
                  resolve();
                }
              });
            } catch (error) {
              //console.error(`[DEBUG] ê°ì²´ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜:`, obj, error);
              resolve();
            }
          });
        });

        Promise.all(promises).then(() => {
          tempCanvas.renderAll();
          let canvasImage = tempCanvas.toDataURL({ format: 'png', multiplier: 2 });
          canvasImages.push({
            consentId: pageWrapper.dataset.consentId,
            page: parseInt(pageWrapper.dataset.pageNumber),
            canvasImage: canvasImage,
            pdfHeight: parseFloat(pageWrapper.dataset.canvasHeight),
            scaleFactor: canvas.width / 800
          });
          //console.log(`[DEBUG] ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (í˜ì´ì§€ ${pageWrapper.dataset.pageNumber}):`, canvasImage);

          tempCanvas.dispose();
        }).catch(error => {
          //console.error(`[DEBUG] Promise.all ì˜¤ë¥˜ (í˜ì´ì§€ ${pageWrapper.dataset.pageNumber}):`, error);
        });
      });

      setTimeout(() => {
        fetch('/finalize_signatures', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            selectedConsents: selectedConsents,
            signatures: selectedSignatureAreaList,
            signatureData: signatureData,
            canvasImages: canvasImages
          })
        }).then(response => response.json())
          .then(data => {
            if (data.signed_pdf) {
              alert("ëª¨ë“  ì„œëª… ë° ìº”ë²„ìŠ¤ ê°ì²´ê°€ ìµœì¢… PDFì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!");
              //console.log("âœ… ìµœì¢… ì €ì¥ ì™„ë£Œ!", data.signed_pdf);
            } else {
              alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              console.error("ğŸš¨ ì„œë²„ ì‘ë‹µ:", data);
            }
          }).catch(error => {
            console.error("ğŸš¨ fetch ì˜¤ë¥˜:", error);
            alert("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }, 1000);
    }

    function getValueFromFieldPath(data, path) {
      const value = path.split('.').reduce((obj, key) => obj?.[key], data);

      // ì²´í¬ë°•ìŠ¤ìš© í•„ë“œ ì²˜ë¦¬
      if (typeof value === "boolean") {
        return value ? "âœ”" : "";  // ì²´í¬ëœ ê±´ â˜‘, ì•„ë‹Œ ê±´ â–¡
      }

      return value ?? "";
    }

    function getDiseaseDisplayValue(diseasesArray, fieldName) {
      const disease = diseasesArray.find(d => d.name === fieldName);
      if (!disease) return "";
      if (disease.detail && disease.detail.trim()) {
        return disease.detail; // ë‚´ìš© ì…ë ¥ëœ ê²½ìš° ë‚´ìš© ì¶œë ¥
      } else if (disease.checked) {
        return "âœ”"; // ì²´í¬ë§Œ í•œ ê²½ìš°ëŠ” 'âœ”' í‘œì‹œ
      }
      return "";
    }

    window.onload = function () {
      const defaultConsent = "basic_consent";
      loadPdf(defaultConsent);

      const patientData = JSON.parse(sessionStorage.getItem("patientData") || "{}");
      //console.log("ë„˜ì–´ì˜¨ í™˜ì ì •ë³´:", patientData);

      fetch("/backend/get_signature_areas/basic_consent_signature_areas.json")
        .then(res => res.json())
        .then(positions => {
          setTimeout(() => {
            positions.forEach(pos => {
              const { page, left, top, field } = pos;
              let value = "";

              if (field.startsWith("diseases.")) {
                const diseaseName = field.split(".")[1];
                value = getDiseaseDisplayValue(patientData.diseases || [], diseaseName);
              } else {
                value = getValueFromFieldPath(patientData, field) || "";
              }

              const canvasWrapper = document.querySelector(
                `.canvas-wrapper[data-consent-id="${defaultConsent}"][data-page-number="${page}"]`
              );

              if (!canvasWrapper || !canvasWrapper.fabricCanvas || !value) return;

              const canvas = canvasWrapper.fabricCanvas;

              const text = new fabric.Text(value, {
                left,
                top,
                fontSize: 15,
                fill: "black",
                originX: "center",
                originY: "center",
                selectable: false
              });

              canvas.add(text);
              canvas.renderAll();
            });
          }, 1000); // PDFê°€ ë¡œë”©ëœ í›„ ì‹¤í–‰ë˜ê²Œ íƒ€ì´ë° ì¡°ì ˆ
        })
        .catch(err => console.error("âŒ JSON ì¢Œí‘œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
    };
  </script>
</body>
</html>