<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì „ì ë™ì˜ì„œ - ì„œëª… ìœ„ì¹˜ ì§€ì •</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 40px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #f9f9f9;
      position: relative;
    }
    .pdf-container {
      margin-top: 20px;
      padding: 0;
      position: relative;
    }
    .canvas-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    canvas {
      border: 1px solid black;
    }
    #consent-sidebar {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: row;
      gap: 10px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      z-index: 2000;
    }
    .layer {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #layer2, #layer3 {
      display: none;
    }
    #consent-sidebar button {
      padding: 8px;
      border: none;
      cursor: pointer;
      background-color: #28a745;
      color: white;
      border-radius: 5px;
    }
    #signatureList {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    #signatureList th, #signatureList td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #signatureList th {
      background-color: #f2f2f2;
    }
    #downloadBtn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #downloadBtn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì „ì ë™ì˜ì„œ - ì„œëª… ìœ„ì¹˜ ì§€ì •</h1>
    <p>ì•„ë˜ì—ì„œ ë™ì˜ì„œë¥¼ ì„ íƒí•˜ê³  ì„œëª… ìœ„ì¹˜ë¥¼ ì§€ì •í•˜ì„¸ìš”.</p>
    <div id="pdf-container" class="pdf-container"></div>
    <br>
    <button onclick="toggleAddMode()">ì„œëª… ìœ„ì¹˜ ì¶”ê°€ ëª¨ë“œ</button>
    <button onclick="saveToServer()">ì„œë²„ì— ì €ì¥</button>
  </div>

  <div id="consent-sidebar">
    <div id="layer1" class="layer">
      <button onclick="selectLayer1('surgery')">ìˆ˜ìˆ </button>
      <button onclick="selectLayer1('procedure')">ì‹œìˆ </button>
      <button onclick="selectLayer1('underlying')">ê¸°ì €ì§ˆí™˜</button>
    </div>
    <div id="layer2" class="layer"></div>
    <div id="layer3" class="layer"></div>
  </div>

  <button id="downloadBtn" onclick="downloadJSON()">JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>

  <h2>ì„œëª… ìœ„ì¹˜ ëª©ë¡</h2>
  <table id="signatureList">
    <thead>
      <tr>
        <th>ë™ì˜ì„œ ID</th>
        <th>í˜ì´ì§€</th>
        <th>Left</th>
        <th>Top</th>
        <th>ë„ˆë¹„</th>
        <th>ë†’ì´</th>
        <th>ì‘ì—…</th>
      </tr>
    </thead>
    <tbody id="signatureListBody"></tbody>
  </table>

  <script>
    console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨");

    // PDF.js ì„¤ì •
    var pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    let selectedConsents = [];
    let pdfContainer = document.getElementById("pdf-container");
    let fabricCanvases = [];
    let consentPages = {};
    let signatures = [];
    let addMode = false;

    function loadSignatureAreas(consent) {
        if (!consentPages[consent]) {
            console.warn(`ğŸš¨ PDFê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ: ${consent}, ì„œëª… ì˜ì—­ ë¡œë“œ ìŠ¤í‚µ`);
            return;
        }
        const encodedConsent = encodeURIComponent(consent);
        const url = `/backend/get_signature_areas/${encodedConsent}_signature_areas.json`;
        console.log("ğŸ”„ ì„œëª… ì˜ì—­ ë¡œë“œ URL:", url);
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log("âœ… ë¶ˆëŸ¬ì˜¨ ì„œëª… ì˜ì—­ ë°ì´í„°:", data);
                signatures = data;
                renderSignatures();
                updateTable();
            })
            .catch(error => console.error("ğŸš¨ ì„œëª… ì˜ì—­ ë¡œë“œ ì‹¤íŒ¨:", error));
    }

    let consentOrderCounter = 0;
    function loadPdf(consent) {
      consentOrderCounter++;
      let currentConsentOrder = consentOrderCounter;
      // ê¸°ì¡´ ì„ íƒëœ ë™ì˜ì„œ ì œê±°
      if (selectedConsents.length > 0) {
        selectedConsents.forEach(existingConsent => {
          removeConsent(existingConsent);
        });
      }
      selectedConsents = [consent]; // ë‹¨ì¼ ë™ì˜ì„œ ì„ íƒ
      let loadingTask = pdfjsLib.getDocument(`/static/pdfs/${consent}.pdf`);
      loadingTask.promise.then(pdf => {
        console.log(`ğŸ“„ PDF ë¬¸ì„œ ë¡œë“œë¨: ${consent}, ì´ í˜ì´ì§€ ìˆ˜: ${pdf.numPages}`);
        let pagePromises = [];
        let pageData = []; // í˜ì´ì§€ ë°ì´í„°ë¥¼ ì €ì¥
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pagePromises.push(
            pdf.getPage(pageNum).then(page => {
              const scale = 1.34; // ë™ì¼í•œ scale ì ìš©
              const viewport = page.getViewport({ scale: scale });
              let canvasWrapper = document.createElement("div");
              canvasWrapper.className = "canvas-wrapper";
              canvasWrapper.dataset.pageNumber = pageNum;
              canvasWrapper.dataset.consentId = consent;
              canvasWrapper.dataset.pageCount = pdf.numPages;
              canvasWrapper.dataset.consentOrder = currentConsentOrder;
              canvasWrapper.style.width = viewport.width + "px";
              canvasWrapper.style.height = viewport.height + "px";
              let pdfCanvas = document.createElement("canvas");
              pdfCanvas.width = viewport.width;
              pdfCanvas.height = viewport.height;
              pdfCanvas.style.position = "absolute";
              pdfCanvas.style.top = "0";
              pdfCanvas.style.left = "0";
              pdfCanvas.style.pointerEvents = "none";
              canvasWrapper.dataset.canvasHeight = viewport.height;
              console.log(`PDF Canvas Height for page ${pageNum}: ${viewport.height}`);
              let overlayCanvas = document.createElement("canvas");
              overlayCanvas.width = viewport.width;
              overlayCanvas.height = viewport.height;
              overlayCanvas.style.position = "absolute";
              overlayCanvas.style.top = "0";
              overlayCanvas.style.left = "0";
              overlayCanvas.style.pointerEvents = "auto";
              overlayCanvas.style.zIndex = "100";
              overlayCanvas.style.touchAction = "none";
              let context = pdfCanvas.getContext("2d");
              page.render({ canvasContext: context, viewport: viewport });
              canvasWrapper.appendChild(pdfCanvas);
              canvasWrapper.appendChild(overlayCanvas);
              let fabricCanvas = new fabric.Canvas(overlayCanvas, { selection: false });
              fabricCanvas.calcOffset();
              canvasWrapper.fabricCanvas = fabricCanvas;
              fabricCanvas.wrapper = canvasWrapper; // ìº”ë²„ìŠ¤ì™€ ë˜í¼ ì—°ê²°
              fabricCanvases.push(fabricCanvas);
              pageData.push({ pageNum: pageNum, wrapper: canvasWrapper });
              return { pageNum: pageNum, wrapper: canvasWrapper };
            })
          );
        }
        Promise.all(pagePromises).then(() => {
          // í˜ì´ì§€ ë²ˆí˜¸ë¡œ ì •ë ¬
          pageData.sort((a, b) => a.pageNum - b.pageNum);
          pdfContainer.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
          pageData.forEach(data => pdfContainer.appendChild(data.wrapper));
          consentPages[consent] = pageData.map(data => data.wrapper);
          console.log(`âœ… ë™ì˜ì„œ ${consent} í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì •ë ¬ í›„ ìˆœì„œ:`, pageData.map(d => d.pageNum));
          loadSignatureAreas(consent);
          setupClickListener(); // ëª¨ë“  ìº”ë²„ìŠ¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          setupKeyboardListener(); // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        });
      }).catch(error => console.error("ğŸš¨ PDF ë¡œë“œ ì—ëŸ¬:", error));
    }

    function setupClickListener() {
      fabricCanvases.forEach(canvas => {
        canvas.off('mouse:down'); // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        console.log(`ğŸ”§ setupClickListener í˜¸ì¶œ, ìº”ë²„ìŠ¤:`, canvas, 'addMode:', addMode, 'wrapper:', canvas.wrapper);
        canvas.on('mouse:down', function(options) {
          console.log('ğŸ–±ï¸ ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸ ê°ì§€, ìº”ë²„ìŠ¤:', canvas);
          const pointer = canvas.getPointer(options.e);
          console.log('ğŸ–±ï¸ í¬ì¸í„° ì¢Œí‘œ:', pointer);
          const pageWrapper = canvas.wrapper;
          const page = parseInt(pageWrapper.dataset.pageNumber);
          const consentId = pageWrapper.dataset.consentId;

          // ê¸°ì¡´ ê°ì²´ í™•ì¸
          const target = canvas.findTarget(options.e, false);
          if (target && target.dataType === 'signatureArea') {
            const actualWidth = Math.round(target.width * target.scaleX); // ì‹¤ì œ ë„ˆë¹„
            const actualHeight = Math.round(target.height * target.scaleY); // ì‹¤ì œ ë†’ì´
            console.log(`âœ… ê¸°ì¡´ signatureArea ì„ íƒ: consentId=${consentId}, page=${page}, left=${Math.round(target.left)}, top=${Math.round(target.top)}, width=${actualWidth}, height=${actualHeight}`);
            canvas.setActiveObject(target); // ê¸°ì¡´ ê°ì²´ ì„ íƒ
            canvas.renderAll();
            return; // ìƒˆ ë°•ìŠ¤ ì¶”ê°€ ë°©ì§€
          }

          // ìƒˆ ë°•ìŠ¤ ì¶”ê°€ (ê¸°ì¡´ ê°ì²´ê°€ ì—†ëŠ” ê²½ìš°)
          if (addMode && !target) {
            const left = Math.round(pointer.x);
            const top = Math.round(pointer.y);
            const width = 145; // ê¸°ë³¸ ë„ˆë¹„
            const height = 50; // ê¸°ë³¸ ë†’ì´

            console.log(`ğŸ–±ï¸ ìƒˆ ì„œëª… ìœ„ì¹˜ ì¶”ê°€: consentId=${consentId}, page=${page}, left=${left}, top=${top}, width=${width}, height=${height}`);

            const index = signatures.length;
            signatures.push({ consentId, page, left, top, width, height, index });
            updateTable();

            // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì‚¬ê°í˜• í‘œì‹œ
            const rect = new fabric.Rect({
              left: left,
              top: top,
              width: width,
              height: height,
              fill: 'rgba(255, 255, 0, 0.3)',
              selectable: true, // ë“œë˜ê·¸ ë° ì´ë™ í™œì„±í™”
              hasControls: true, // í¬ê¸° ì¡°ì • í•¸ë“¤ í™œì„±í™”
              hasBorders: true, // í…Œë‘ë¦¬ í‘œì‹œ
              lockScalingFlip: true, // ë¹„ìœ¨ ê³ ì • ë°©ì§€
              dataType: 'signatureArea',
              index: index // ê°ì²´ì— ì¸ë±ìŠ¤ ì €ì¥
            });
            canvas.add(rect);
            canvas.setActiveObject(rect); // ìƒˆë¡œ ì¶”ê°€ëœ ê°ì²´ ì„ íƒ
            canvas.renderAll();
            console.log('âœ… ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë…¸ë€ìƒ‰ ë°•ìŠ¤ ì¶”ê°€ë¨:', rect);

            // ê°ì²´ ì´ë™ ë° í¬ê¸° ë³€ê²½ í›„ ë°ì´í„° ì—…ë°ì´íŠ¸
            rect.on('scaling', function() {
                console.log('ğŸ“ ì‚¬ê°í˜• í¬ê¸° ì¡°ì ˆ ì¤‘: width=', Math.round(rect.width * rect.scaleX), 'height=', Math.round(rect.height * rect.scaleY));
            });
            rect.on('modified', function() {
                const newLeft = Math.round(rect.left);
                const newTop = Math.round(rect.top);
                const newWidth = Math.round(rect.width * rect.scaleX);
                const newHeight = Math.round(rect.height * rect.scaleY);
                const index = signatures.findIndex(sig => sig.index === rect.index);
                if (index !== -1) {
                    signatures[index] = { ...signatures[index], left: newLeft, top: newTop, width: newWidth, height: newHeight };
                    updateTable();
                    console.log(`ğŸ”„ ì„œëª… ìœ„ì¹˜ ìˆ˜ì •ë¨: consentId=${signatures[index].consentId}, page=${signatures[index].page}, left=${newLeft}, top=${newTop}, width=${newWidth}, height=${newHeight}`);
                } else {
                    console.warn('ğŸš¨ ìˆ˜ì •ëœ ì‚¬ê°í˜•ì˜ ì¸ë±ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', rect.index);
                }
            });
          }
        });
      });
    }

    function setupKeyboardListener() {
      window.addEventListener('keydown', function(event) {
        if (event.key === 'Delete') {
          console.log('ğŸ–® Delete í‚¤ ì…ë ¥ ê°ì§€');
          fabricCanvases.forEach(canvas => {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.dataType === 'signatureArea') {
              const index = signatures.findIndex(sig => sig.index === activeObject.index);
              if (index !== -1) {
                canvas.remove(activeObject);
                signatures.splice(index, 1);
                updateTable();
                renderSignatures();
                canvas.renderAll();
                console.log('âœ… Delete í‚¤ë¡œ ì„ íƒëœ ë°•ìŠ¤ ì‚­ì œë¨, ì¸ë±ìŠ¤:', index);
              }
            }
          });
        }
      });
    }

    function toggleAddMode() {
      addMode = !addMode;
      setupClickListener();
      console.log(`ğŸ”„ ì„œëª… ì¶”ê°€ ëª¨ë“œ ${addMode ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
      alert(addMode ? 'ì„œëª… ìœ„ì¹˜ ì¶”ê°€ ëª¨ë“œ í™œì„±í™”' : 'ì„œëª… ìœ„ì¹˜ ì¶”ê°€ ëª¨ë“œ ë¹„í™œì„±í™”');
    }

    function selectLayer1(category) {
      const layer1Div = document.getElementById('layer1');
      layer1Div.innerHTML = `<button onclick="resetLayer1()">< ë’¤ë¡œê°€ê¸°</button><span style="margin-left:5px; font-weight:bold;">${category}</span>`;
      let layer2Data = [];
      if (category === 'surgery') {
        layer2Data = ["ì‹¬ì¥ ìˆ˜ìˆ ", "ë‡Œ ìˆ˜ìˆ ", "ë³µë¶€ ìˆ˜ìˆ ", "ì •í˜•ì™¸ê³¼ ìˆ˜ìˆ ", "í‰ë¶€ ìˆ˜ìˆ ", "ì†Œì•„ì™¸ê³¼ ìˆ˜ìˆ ", "ì„±í˜• ìˆ˜ìˆ ", "ë¹„ë‡¨ê¸°ê³¼ ìˆ˜ìˆ ", "ì•ˆë©´ ìˆ˜ìˆ ", "ì¼ë°˜ì™¸ê³¼ ìˆ˜ìˆ "];
      } else if (category === 'procedure') {
        layer2Data = ["ì¹˜ê³¼ ì‹œìˆ ", "ì•ˆê³¼ ì‹œìˆ ", "í”¼ë¶€ ì‹œìˆ ", "ì •í˜• ì‹œìˆ ", "ë‚´ì‹œê²½ ì‹œìˆ ", "ë ˆì´ì € ì‹œìˆ ", "ì£¼ì‚¬ ì‹œìˆ ", "ì¬í™œ ì‹œìˆ ", "ë¯¸ìš© ì‹œìˆ ", "ë¹„ì¹¨ìŠµ ì‹œìˆ "];
      } else if (category === 'underlying') {
        layer2Data = ["ë‹¹ë‡¨ë³‘", "ê³ í˜ˆì••", "ì‹¬í˜ˆê´€ ì§ˆí™˜", "ë§Œì„± í˜¸í¡ê¸° ì§ˆí™˜", "ë§Œì„± ì‹ ì¥ ì§ˆí™˜", "ê°„ ì§ˆí™˜", "ë©´ì—­ ì§ˆí™˜", "ë¹„ë§Œ", "ê°‘ìƒì„  ì§ˆí™˜", "ê´€ì ˆì—¼"];
      }
      const layer2Div = document.getElementById('layer2');
      layer2Div.innerHTML = '';
      layer2Data.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item;
        btn.onclick = function() { selectLayer2(category, item); };
        layer2Div.appendChild(btn);
      });
      layer2Div.style.display = "flex";
      const layer3Div = document.getElementById('layer3');
      layer3Div.innerHTML = '';
      layer3Div.style.display = "none";
    }

    function resetLayer1() {
      const layer1Div = document.getElementById('layer1');
      layer1Div.innerHTML = `
        <button onclick="selectLayer1('surgery')">ìˆ˜ìˆ </button>
        <button onclick="selectLayer1('procedure')">ì‹œìˆ </button>
        <button onclick="selectLayer1('underlying')">ê¸°ì €ì§ˆí™˜</button>
      `;
      document.getElementById('layer2').innerHTML = '';
      document.getElementById('layer2').style.display = "none";
      document.getElementById('layer3').innerHTML = '';
      document.getElementById('layer3').style.display = "none";
    }

    function selectLayer2(category, subCategory) {
      const layer2Div = document.getElementById('layer2');
      layer2Div.innerHTML = `<button onclick="resetLayer2('${category}')">< ë’¤ë¡œê°€ê¸°</button><span style="margin-left:5px; font-weight:bold;">${subCategory}</span>`;
      let layer3Data = [];
      if (category === 'surgery') {
        if (subCategory === "ì‹¬ì¥ ìˆ˜ìˆ ") {
          layer3Data = ["ë§ˆì·¨ ë™ì˜ì„œ", "ê´€ì ˆê²½ ê²€ì‚¬", "ì‹¬ê·¼ì¬ìƒì¹˜ë£Œ ë™ì˜ì„œ", "ì‹¬ì¥ë™ë§¥ìŠ¤í…íŠ¸ ì‚½ì… ë™ì˜ì„œ", "ì‹¬ì¥ì „ë„ê³„ ìˆ˜ìˆ  ë™ì˜ì„œ"];
        } else if (subCategory === "ë‡Œ ìˆ˜ìˆ ") {
          layer3Data = ["ë‡Œì¢…ì–‘ ì ˆì œìˆ  ë™ì˜ì„œ", "ë‡Œë™ë§¥ë¥˜ í´ë¦¬í•‘ ë™ì˜ì„œ", "ë‡Œì¶œí˜ˆ ì‘ê¸‰ ìˆ˜ìˆ  ë™ì˜ì„œ", "ë‡Œì‹ ê²½ ì¬ê±´ìˆ  ë™ì˜ì„œ", "ë‡Œë‚´ ì¶œí˜ˆ ì¹˜ë£Œ ë™ì˜ì„œ"];
        }
      } else if (category === 'procedure') {
        if (subCategory === "ì¹˜ê³¼ ì‹œìˆ ") {
          layer3Data = ["ì„í”Œë€íŠ¸ ì‹œìˆ  ë™ì˜ì„œ", "ì¹˜ì•„ êµì • ì‹œìˆ  ë™ì˜ì„œ", "ì¹˜ì£¼ ì¹˜ë£Œ ë™ì˜ì„œ", "ë³´ì²  ì¹˜ë£Œ ë™ì˜ì„œ", "ì¹˜ê·¼ ì ˆì œ ì‹œìˆ  ë™ì˜ì„œ"];
        }
      } else if (category === 'underlying') {
        if (subCategory === "ë‹¹ë‡¨ë³‘") {
          layer3Data = ["ë‹¹ë‡¨ë³‘ ê´€ë¦¬ ë™ì˜ì„œ", "ë‹¹ë‡¨ë³‘ ì¹˜ë£Œ ë™ì˜ì„œ", "ì¸ìŠë¦° íˆ¬ì—¬ ë™ì˜ì„œ", "í˜ˆë‹¹ ê´€ë¦¬ ë™ì˜ì„œ", "ë‹¹ë‡¨ í•©ë³‘ì¦ ì˜ˆë°© ë™ì˜ì„œ"];
        }
      }
      const layer3Div = document.getElementById('layer3');
      layer3Div.innerHTML = '';
      layer3Data.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item;
        btn.onclick = function() { selectFinalConsent(item, this); };
        if (selectedConsents.includes(item)) {
          btn.style.backgroundColor = "#aaa";
          btn.style.cursor = "default";
        }
        layer3Div.appendChild(btn);
      });
      layer3Div.style.display = "flex";
    }

    function resetLayer2(category) {
      let layer2Data = [];
      if (category === 'surgery') {
        layer2Data = ["ì‹¬ì¥ ìˆ˜ìˆ ", "ë‡Œ ìˆ˜ìˆ ", "ë³µë¶€ ìˆ˜ìˆ ", "ì •í˜•ì™¸ê³¼ ìˆ˜ìˆ ", "í‰ë¶€ ìˆ˜ìˆ ", "ì†Œì•„ì™¸ê³¼ ìˆ˜ìˆ ", "ì„±í˜• ìˆ˜ìˆ ", "ë¹„ë‡¨ê¸°ê³¼ ìˆ˜ìˆ ", "ì•ˆë©´ ìˆ˜ìˆ ", "ì¼ë°˜ì™¸ê³¼ ìˆ˜ìˆ "];
      } else if (category === 'procedure') {
        layer2Data = ["ì¹˜ê³¼ ì‹œìˆ ", "ì•ˆê³¼ ì‹œìˆ ", "í”¼ë¶€ ì‹œìˆ ", "ì •í˜• ì‹œìˆ ", "ë‚´ì‹œê²½ ì‹œìˆ ", "ë ˆì´ì € ì‹œìˆ ", "ì£¼ì‚¬ ì‹œìˆ ", "ì¬í™œ ì‹œìˆ ", "ë¯¸ìš© ì‹œìˆ ", "ë¹„ì¹¨ìŠµ ì‹œìˆ "];
      } else if (category === 'underlying') {
        layer2Data = ["ë‹¹ë‡¨ë³‘", "ê³ í˜ˆì••", "ì‹¬í˜ˆê´€ ì§ˆí™˜", "ë§Œì„± í˜¸í¡ê¸° ì§ˆí™˜", "ë§Œì„± ì‹ ì¥ ì§ˆí™˜", "ê°„ ì§ˆí™˜", "ë©´ì—­ ì§ˆí™˜", "ë¹„ë§Œ", "ê°‘ìƒì„  ì§ˆí™˜", "ê´€ì ˆì—¼"];
      }
      const layer2Div = document.getElementById('layer2');
      layer2Div.innerHTML = '';
      layer2Data.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item;
        btn.onclick = function() { selectLayer2(category, item); };
        layer2Div.appendChild(btn);
      });
      layer2Div.style.display = "flex";
      const layer3Div = document.getElementById('layer3');
      layer3Div.innerHTML = '';
      layer3Div.style.display = "none";
    }

    function selectFinalConsent(consentId, btn) {
      if (selectedConsents.includes(consentId)) {
        if (confirm(consentId + " ë™ì˜ì„œë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          removeConsent(consentId);
          btn.style.backgroundColor = "#28a745";
          btn.style.cursor = "pointer";
        }
        return;
      }
      loadPdf(consentId);
      alert(consentId + " ë™ì˜ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      btn.style.backgroundColor = "#aaa";
      btn.style.cursor = "default";
    }

    function removeConsent(consent) {
      if (!selectedConsents.includes(consent)) {
        alert(consent + " ë™ì˜ì„œëŠ” ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      console.log(`ì‚­ì œ ìš”ì²­ëœ ë™ì˜ì„œ: ${consent}`);
      if (consentPages[consent]) {
        consentPages[consent].forEach(wrapper => {
          if (pdfContainer.contains(wrapper)) {
            pdfContainer.removeChild(wrapper);
            console.log(`âœ… ì‚­ì œëœ ë™ì˜ì„œ í˜ì´ì§€: ${consent}, í˜ì´ì§€ ë²ˆí˜¸: ${wrapper.dataset.pageNumber}`);
          } else {
            console.warn(`ğŸš¨ ì‚­ì œí•˜ë ¤ëŠ” ë™ì˜ì„œ(${consent})ì˜ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ`);
          }
        });
        delete consentPages[consent];
      } else {
        console.warn(`ğŸš¨ consentPages[${consent}]ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ`);
      }
      let updatedCanvases = [];
      fabricCanvases.forEach(canvas => {
        if (!canvas.wrapper || canvas.wrapper.dataset.consentId !== consent) {
          updatedCanvases.push(canvas);
        } else {
          console.log(`âœ… ì‚­ì œëœ fabricCanvas ê´€ë ¨ ë™ì˜ì„œ: ${consent}`);
        }
      });
      fabricCanvases = updatedCanvases;
      signatures = signatures.filter(sig => sig.consentId !== consent);
      selectedConsents = selectedConsents.filter(item => item !== consent);
      console.log(`âœ… í˜„ì¬ ì„ íƒëœ ë™ì˜ì„œ ëª©ë¡:`, selectedConsents);
      updateTable();
      renderSignatures();
      alert(consent + " ë™ì˜ì„œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤");
    }

    function saveToServer() {
      fetch('/save_signature_areas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          signature_areas: signatures
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert(data.message);
        } else {
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          console.error('ğŸš¨ ì„œë²„ ì‘ë‹µ:', data);
        }
      })
      .catch(error => {
        console.error('ğŸš¨ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }

    function downloadJSON() {
      const jsonData = JSON.stringify(signatures, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `signature_areas.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateTable() {
      const tbody = document.getElementById('signatureListBody');
      tbody.innerHTML = '';
      signatures.forEach((sig, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${sig.consentId || 'undefined'}</td>
          <td>${sig.page}</td>
          <td>${sig.left}</td>
          <td>${sig.top}</td>
          <td>${sig.width}</td>
          <td>${sig.height}</td>
          <td>
            <button onclick="editSignature(${index})">ìˆ˜ì •</button>
            <button onclick="deleteSignature(${index})">ì‚­ì œ</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function editSignature(index) {
      const sig = signatures[index];
      signatures.splice(index, 1);
      updateTable();
      renderSignatures();
    }

    function deleteSignature(index) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        signatures.splice(index, 1);
        updateTable();
        renderSignatures();
      }
    }

    function renderSignatures() {
      fabricCanvases.forEach(canvas => {
        console.log('ğŸ”§ renderSignatures í˜¸ì¶œ, ìº”ë²„ìŠ¤:', canvas, 'wrapper:', canvas.wrapper);
        canvas.getObjects().forEach(obj => {
          if (obj.dataType === 'signatureArea') {
            canvas.remove(obj);
            console.log('âœ… ê¸°ì¡´ signatureArea ì œê±°:', obj);
          }
        });
        signatures.forEach((sig, index) => {
          if (canvas.wrapper && canvas.wrapper.dataset.consentId === sig.consentId && canvas.wrapper.dataset.pageNumber == sig.page) {
            const rect = new fabric.Rect({
              left: sig.left,
              top: sig.top,
              width: sig.width,
              height: sig.height,
              fill: 'rgba(255, 255, 0, 0.3)',
              selectable: true, // ë“œë˜ê·¸ ë° ì´ë™ í™œì„±í™”
              hasControls: true, // í¬ê¸° ì¡°ì • í•¸ë“¤ í™œì„±í™”
              hasBorders: true, // í…Œë‘ë¦¬ í‘œì‹œ
              lockScalingFlip: true, // ë¹„ìœ¨ ê³ ì • ë°©ì§€
              dataType: 'signatureArea',
              index: index // ê°ì²´ì— ì¸ë±ìŠ¤ ì €ì¥
            });
            canvas.add(rect);
            console.log('âœ… ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë…¸ë€ìƒ‰ ë°•ìŠ¤ ì¶”ê°€:', rect, 'ìº”ë²„ìŠ¤ í¬ê¸°:', { width: canvas.width, height: canvas.height });

            // ê°ì²´ ì´ë™ ë° í¬ê¸° ë³€ê²½ í›„ ë°ì´í„° ì—…ë°ì´íŠ¸
            rect.on('modified', function() {
              const newLeft = Math.round(rect.left);
              const newTop = Math.round(rect.top);
              const newWidth = Math.round(rect.width * rect.scaleX);
              const newHeight = Math.round(rect.height * rect.scaleY);
              const index = signatures.findIndex(s => s.index === rect.index);
              if (index !== -1) {
                signatures[index] = { ...signatures[index], left: newLeft, top: newTop, width: newWidth, height: newHeight };
                updateTable();
                console.log(`ğŸ”„ ì„œëª… ìœ„ì¹˜ ìˆ˜ì •ë¨: consentId=${signatures[index].consentId}, page=${signatures[index].page}, left=${newLeft}, top=${newTop}, width=${newWidth}, height=${newHeight}`);
              }
            });
          }
        });
        canvas.renderAll();
        console.log('âœ… ìº”ë²„ìŠ¤ ë Œë”ë§ ì™„ë£Œ:', canvas);
      });
      console.log('âœ… ëª¨ë“  ì„œëª… ì˜ì—­ ë Œë”ë§ ì™„ë£Œ');
    }

    // window.onloadì—ì„œ ê¸°ë³¸ ë™ì˜ì„œ ë¡œë“œ ì œê±°
    window.onload = function() {
      console.log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ê¸°ë³¸ ë™ì˜ì„œ ë¡œë“œ ì•ˆ í•¨");
    };
  </script>
</body>
</html>